<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>注册页面</title>
    <script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
    <link rel="stylesheet" href="css/recallPassword.css">

    <script type="text/javascript" src="js/jquery-getUrlParam.js"></script>
    <script type="text/javascript" src="js/jquery.cookie.js"></script>
</head>
<body>
<div class="content">
    <div class="title">
        <div class="title-content">
            <div class="img"><img src="images/注册.png" width="50px" height="50px" alt=""></div>
            <div class="text">重置密码</div>
        </div>
    </div>
    <div class="mian">
        <form id="form-register">

            <div class="title-username">
                <h4>请输入用户名</h4>
                <p>
                    <span class="input-text">用户名</span>
                    <label><input id="username" type="text" class="username input" placeholder="请输入用户名"
                                  required="required"/></label>
                </p>
            </div>
            <div class="title-username">
                <h4>请输入用户邮箱</h4>
                <p>
                    <span class="input-text">邮箱</span>
                    <label><input id="email" type="text" class="username input" placeholder="请输入用户邮箱"
                                  required="required"/></label>
                    <input type="button" class="btn" style="margin-left: 20PX" value="获取验证码" id="codeBtn">
                    <span id="msg"></span>
                </p>
            </div>
            <div class="title-username">
                <h4>请输入验证码</h4>
                <p>
                    <span class="input-text">验证码</span>
                    <label><input id="code" type="text" class="username input" placeholder="请输入验证码"
                                  required="required"
                    /></label>
                </p>
            </div>
            <div class="title-password">
                <h4>请输入重置密码 <span class="input-text" style="width: 200px;"></span></h4>
                <p>
                    <span class="input-text">重置密码</span>
                    <label><input id="password" type="password" class="password input" required="required"
                                  placeholder="请输入重置密码"/></label>
                </p>
                <p>
                    <span class="input-text">密码确认</span>
                    <label><input id="passwordto" type="password" class="password input" required="required"
                                  placeholder="确认密码"
                    /></label>
                </p>
                <p id="phonenumberNode">两次输入的密码不相同</p>

            </div>
            <div class="submit">
                <input id="reset" type="button" style="margin-left: 70PX" value="重 置"/>
            </div>
        </form>
    </div>
</div>
<!--	以下为js的代码-->
<script type="text/javascript">
    $("#reset").click(function () {
        //拿到单表的属性
        let username = $("#username").val(); //拿到用户名
        let email = $.trim($("#email").val()); //拿到邮箱
        let code = $.trim($("#code").val()); //得到验证码
        let password = $.trim($("#password").val()); //拿到密码
        let checkingPass = $.trim($("#passwordto").val()); //拿到确认密码
        /*
        * 以下为表单验证
        * */
        //检验用户账号
        if (username === "") {
            alert("请输入用户名！");
            return;
        }
        //验证码
        if (code === "") {
            alert("请输入验证码");
            return;
        }
        //检查确认密码和重置密码是否相等
        if (password !== checkingPass) {
            $("#phonenumberNode").css("opacity", 1)
        }
        //定义正则表达式的变量:邮箱正则
        let reg = /^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/;
        if (!(email !== null && email.search(reg) !== -1)) {
            alert("邮箱格式错误,请重新输入！");
            return;
        }

        //重置密码
        resetPassword(username, password, code);
    });

    //获取验证码的点击事件
    $("#codeBtn").click(function () {
        const emailValue = $("#codeBtn").val();
        //保证用户不会输入一个空值
        if (emailValue === null) {
            alert("邮箱不能为空")
            return
        }
        //发送ajax请求
        sendCode();
    })


    //发送邮箱的ajax逻辑
    function sendCode() {
        $.ajax({
            url: 'mails/getCode',
            type: 'get',
            data: "email=" + $("#email").val(),
            dataType: "json",
            success: function (json) {
                if (json.state === 200) {
                    //成功后将 获取验证码框 隐藏
                    $("#codeBtn").css("visibility", "hidden")
                    alert("验证码已发送");
                } else {
                    alert("获取验证码失败" + json.message)
                }
            },
            error: function (xhr) {
                alert("获取验证码时产生未知错误" + "\n" + xhr.status)
            }
        });
    }

    //重置密码的ajax逻辑
    function resetPassword(username, password, code) {
        $.ajax({
            url: 'users/reset',
            type: 'post',
            data: {
                username: username,
                password: password,
                code: code
            },
            dataType: "json",
            success: function (json) {
                if (json.state === 200) {
                    alert("重置密码成功")
                    location.href = "login.html"
                } else {
                    alert("重置密码失败" + json.message)
                }
            },
            error: function (xhr) {
                alert("重置密码产生未知错误" + "\n" + xhr.status)
            }
        });
    }
</script>
</body>
</html>